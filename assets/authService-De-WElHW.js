import{i as l,b as c,d as i,m as g,c as m,g as A,u as y,p as u,E as D,r as S,t as f,v as E,G as U,x as C,y as w,s as p,z as I,A as v,B as O}from"./firebaseConfig-ZmQab4ju.js";import{t as n}from"./firebaseErrorHandler-CK0dtUN1.js";const o="users",x={register:async({email:e,password:r,name:t,role:a="Viewer"})=>{try{const d=(await v(u,e,r)).user;await O(d,{displayName:t});const h={uid:d.uid,email:d.email,name:t,role:a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0};return await p(c(i,o,d.uid),h),h}catch(s){n(s)}},login:async(e,r)=>{try{const a=(await I(u,e,r)).user,s=await l(c(i,o,a.uid));if(!s.exists())throw new Error("User profile not found");const d=s.data();if(!d.isActive)throw await w(u),new Error("Account is disabled. Contact administrator.");return d}catch(t){n(t)}},logout:async()=>{try{await w(u)}catch(e){n(e)}},loginWithGoogle:async()=>{try{const e=new U,t=(await C(u,e)).user,a=await l(c(i,o,t.uid));let s;if(a.exists()){if(s=a.data(),!s.isActive)throw await w(u),new Error("Account is disabled. Contact administrator.")}else s={uid:t.uid,email:t.email,name:t.displayName||t.email.split("@")[0],role:"Viewer",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,photoURL:t.photoURL||null},await p(c(i,o,t.uid),s);return s}catch(e){if(e.code==="auth/popup-closed-by-user")throw new Error("Sign-in cancelled");n(e)}},getCurrentUser:async()=>new Promise(e=>{const r=E(u,async t=>{if(r(),t){const a=await l(c(i,o,t.uid));e(a.exists()?a.data():null)}else e(null)})}),changePassword:async(e,r)=>{try{const t=u.currentUser;if(!t||!t.email)throw new Error("No user is currently signed in");const a=D.credential(t.email,e);await S(t,a),await f(t,r)}catch(t){n(t)}},updateUser:async(e,r)=>{try{const t=c(i,o,e);await y(t,{...r,updatedAt:new Date().toISOString()})}catch(t){n(t)}},deleteUser:async e=>{try{const r=c(i,o,e);await y(r,{isActive:!1,updatedAt:new Date().toISOString()})}catch(r){n(r)}},permanentDeleteUser:async e=>{try{await A(c(i,o,e))}catch(r){n(r)}},getAllUsers:async()=>{try{return(await g(m(i,o))).docs.map(r=>({id:r.id,...r.data()}))}catch(e){n(e)}},getUserById:async e=>{try{const r=await l(c(i,o,e));return r.exists()?{id:r.id,...r.data()}:null}catch(r){n(r)}}};export{x as a};
