import{c as T,y as R,z as M,B as q,r as S}from"./index-DAanvQcz.js";import{d,u as p,g as h,a as c,f as v,s as x,q as l,i as w,e as m,o as y,j as A,h as P,k as F,w as B,l as N,m as C}from"./firebaseConfig-CyCI-yMF.js";import{Q as _,u as z}from"./useBaseQuery-DFxn4vC0.js";import{c as D}from"./configService-hzZxIssI.js";const Q=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],ge=T("user",Q);var K=class extends _{constructor(t,e){super(t,e)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:R()})}getOptimisticResult(t){return t.behavior=R(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,e){const{state:r}=t,s=super.createResult(t,e),{isFetching:o,isRefetching:n,isError:u,isRefetchError:a}=s,f=r.fetchMeta?.fetchMore?.direction,E=u&&f==="forward",O=o&&f==="forward",I=u&&f==="backward",k=o&&f==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:q(e,r.data),hasPreviousPage:M(e,r.data),isFetchNextPageError:E,isFetchingNextPage:O,isFetchPreviousPageError:I,isFetchingPreviousPage:k,isRefetchError:a&&!E&&!I,isRefetching:n&&!O&&!k}}};function U(t,e){return z(t,K)}const i="incidents",j=(t,e)=>{if(!c)return console.error("Firebase not configured! Check your .env file"),e&&e(new Error("Firebase not configured")),t([]),()=>{};try{const r=l(h(c,i),y("createdAt","desc"));return P(r,s=>{const o=s.docs.map(n=>({id:n.id,...n.data()}));t(o)},s=>{console.error("Subscription error:",s.message),e&&e(s),t([])})}catch(r){return console.error("Failed to create subscription:",r.message),e&&e(r),t([]),()=>{}}},G=async t=>{try{const e=d(c,i,t),r=await A(e);return r.exists()?{id:r.id,...r.data()}:null}catch(e){throw console.error("Error getting incident:",e),e}},H=async()=>{try{const t=l(h(c,i),y("createdAt","desc"));return(await w(t)).docs.map(r=>({id:r.id,...r.data()}))}catch(t){throw console.error("Error fetching incidents:",t),t}},J=async t=>{try{return(await v(h(c,i),{...t,status:t.status||"Open",priority:t.priority||"Medium",timeline:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),serverTimestamp:x()})).id}catch(e){throw console.error("Error creating incident:",e),e}},V=async(t,e)=>{try{const r=d(c,i,t);await p(r,{...e,updatedAt:new Date().toISOString()})}catch(r){throw console.error("Error updating incident:",r),r}},Z=async t=>{try{const e=d(c,i,t);await m(e)}catch(e){throw console.error("Error deleting incident:",e),e}},W=(t,e)=>{if(!t)return()=>{};const r=h(c,i,t,"events"),s=l(r);return P(s,o=>{const n=o.docs.map(u=>({id:u.id,...u.data()}));e(n)},o=>console.error("Error subscribing to events sub-collection:",o))},L=async(t,e)=>{try{const r=h(c,i,t,"events"),s={...e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},o=await v(r,s),n=d(c,i,t);return await p(n,{updatedAt:x()}),{id:o.id,...s}}catch(r){throw console.error("Error adding event:",r),r}},X=async(t,e,r)=>{try{const s=e.id||r.id;if(!s)throw new Error("Event ID missing for update");const o=d(c,i,t,"events",s),n={...r,updatedAt:new Date().toISOString()};return await p(o,n),{id:s,...n}}catch(s){throw console.error("Error updating event:",s),s}},$=async(t,e)=>{try{const r=e.id;if(!r)throw new Error("Event ID missing for delete");const s=d(c,i,t,"events",r);await m(s)}catch(r){throw console.error("Error deleting event:",r),r}},Y=async t=>{try{const e=h(c,i,t,"events");return(await w(e)).docs.map(s=>({id:s.id,...s.data()}))}catch(e){return console.error("Error fetching events:",e),[]}},ee=L,te=async(t,e,r)=>{const s=d(c,i,t,"events",e);await p(s,{...r,updatedAt:new Date().toISOString()})},re=async(t,e)=>{const r=d(c,i,t,"events",e);await m(r)},se=async(t,e)=>{console.warn("Reorder not fully optimized for sub-collections yet")},ne=async t=>{try{let e=0,r=0;for(const s of t){const o=l(h(c,i),where("ticket","==",s.ticket)),n=await w(o),u={...s,updatedAt:new Date().toISOString()};if(n.empty)await v(h(c,i),{...u,createdAt:s.createdAt||new Date().toISOString(),status:s.status||"Open",priority:s.priority||"Medium",timeline:[]}),e++;else{const a=n.docs[0].id,f=d(c,i,a);await p(f,u),r++}}return{created:e,updated:r}}catch(e){throw console.error("Import Error:",e),e}},fe={subscribeIncidents:j,subscribeEvents:W,getIncidentById:G,getIncidents:H,createIncident:J,updateIncident:V,deleteIncident:Z,addTimelineEvent:L,updateTimelineEvent:X,deleteTimelineEvent:$,getEvents:Y,createEvent:ee,updateEvent:te,deleteEvent:re,reorderEvents:se,importIncidentsFromSheet:ne},g="ticket_logs",oe="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",b=async(t,e)=>{const r={action:t,ticketNumber:e.ticketNumber,ticketType:e.type??e.ticketType,status:e.status,severity:e.severity,category:e.category??"",subCategory:e.subCategory??"",shortDescription:e.shortDesc!==void 0?e.shortDesc:e.shortDescription,detail:e.details!==void 0?e.details:e.detail,actionTaken:e.action!==void 0?e.action:e.actionTaken,resolvedDetail:e.resolvedDetail??"",assign:e.assign??"",remark:e.remark??""};try{fetch(oe,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},ce={subscribeLogs:(t,e=50)=>{const r=l(h(c,g),y("createdAt","desc"),N(e));return P(r,s=>{const o=s.docs.map(n=>({id:n.id,...n.data()}));t(o,s.docs[s.docs.length-1])})},fetchMoreLogs:async(t,e=20)=>{try{const r=[y("createdAt","desc"),N(e)];t&&r.push(C(t));const s=l(h(c,g),...r),o=await w(s);return{data:o.docs.map(n=>({id:n.id,...n.data()})),lastDoc:o.docs[o.docs.length-1]||null}}catch{return{data:[],lastDoc:null}}},importLogsFromSheet:async t=>{const r=[];for(let s=0;s<t.length;s+=500)r.push(t.slice(s,s+500));for(const s of r){const o=B(c);s.forEach(n=>{const u=n.ticketNumber?d(c,g,String(n.ticketNumber)):d(h(c,g));o.set(u,{...n,createdAt:n.date?new Date(n.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await o.commit()}return{success:!0,count:t.length}},createLog:async t=>{if(t.ticketNumber){const e=d(c,g,String(t.ticketNumber));if((await A(e)).exists())throw new Error(`Ticket ${t.ticketNumber} exists!`);await F(e,{...t,createdAt:new Date().toISOString()})}else await v(h(c,g),{...t,createdAt:new Date().toISOString()});b("create",t)},updateLog:async(t,e)=>{const r=d(c,g,String(t));await p(r,e),b("update",{ticketNumber:t,...e})},deleteLog:async t=>{const e=d(c,g,String(t));await m(e),b("delete",{ticketNumber:t})}},le=()=>{const{data:t,fetchNextPage:e,hasNextPage:r,isFetchingNextPage:s,isLoading:o}=U({queryKey:["ticketLogs"],queryFn:async({pageParam:a=null})=>await ce.fetchMoreLogs(a),initialPageParam:null,getNextPageParam:a=>a.lastDoc||void 0}),n=t?.pages.flatMap(a=>a.data)||[],u={total:n.length,incidents:n.filter(a=>a.type==="Incident").length,requests:n.filter(a=>a.type==="Request"||a.type==="Service Request").length};return{logs:n,loading:o,loadingMore:s,hasMore:r,loadMore:e,stats:u}};function pe(){const[t,e]=S.useState(D.getDefaultTicketOptions()),[r,s]=S.useState(!0);return S.useEffect(()=>{const o=D.subscribeTicketOptions(n=>{e(n),s(!1)});return()=>o()},[]),{ticketOptions:t,loading:r}}export{ge as U,le as a,fe as i,ce as t,pe as u};
