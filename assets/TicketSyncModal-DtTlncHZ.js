const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DeB0UNQi.js","assets/index-B_3iS1_v.css"])))=>i.map(i=>d[i]);
import{r as x,A as O,_ as T,j as e,F as P,C as M,L as I,R as A,X as Y}from"./index-DeB0UNQi.js";import{C as E}from"./cloud-download-ChoXo7XV.js";import{C as F}from"./formatters-BaVPdGTo.js";import{A as K}from"./arrow-right-BKpbOeSf.js";import{D as V}from"./database-C_SdLRok.js";import{p as R}from"./parse-B07Sz6Sq.js";import{i as _}from"./format-DGoV6LV2.js";import{a as G}from"./setYear-D3UzLEUF.js";import"./chevron-down-C0MtzhZK.js";import"./rotate-ccw-BIVUIMXV.js";const U="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",L=i=>{if(!i)return new Date().toISOString();const n=new Date(i);if(!isNaN(n.getTime()))return n.toISOString();const l=String(i).trim();let s=R(l,"d/M/yy",new Date);return _(s)?(s.getFullYear()<2e3&&(s=G(s,100),s.getFullYear()<2e3&&s.setFullYear(2e3+parseInt(l.split(/[-/]/)[2]))),s.toISOString()):(s=R(l,"d/M/yyyy",new Date),_(s)?s.toISOString():new Date().toISOString())},f=x.memo(({label:i,value:n,variant:l})=>{const s={new:"bg-emerald-50 dark:bg-emerald-950/30 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-900/50",update:"bg-amber-50 dark:bg-amber-950/30 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-900/50",unchanged:"bg-zinc-50 dark:bg-zinc-900/50 text-zinc-500 border-zinc-200 dark:border-zinc-800"};return e.jsxs("div",{className:`px-3 py-2.5 rounded-lg border text-center ${s[l]}`,children:[e.jsx("span",{className:"text-xl font-black block",children:n}),e.jsx("span",{className:"text-[8px] font-bold uppercase tracking-wider opacity-70",children:i})]})});f.displayName="StatBox";const v=x.memo(({item:i,type:n})=>e.jsxs("div",{className:"px-3 py-2 flex items-center justify-between hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:`w-0.5 h-5 rounded-full shrink-0 ${n==="new"?"bg-emerald-500":"bg-amber-500"}`}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-xs font-bold text-zinc-800 dark:text-zinc-100 truncate",children:["#",i.ticketNumber]}),e.jsx("div",{className:"text-[10px] text-zinc-400 truncate",children:i.shortDesc})]})]}),e.jsx("span",{className:`shrink-0 px-1.5 py-0.5 rounded text-[7px] font-bold uppercase ${n==="new"?"bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-400":"bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400"}`,children:n==="new"?"New":"Update"})]}));v.displayName="PreviewRow";function ae({isOpen:i,onClose:n,onSyncComplete:l,currentLogs:s}){const[d,m]=x.useState("input"),[c,N]=x.useState({newItems:[],updatedItems:[],uptodateItems:[]}),[w,u]=x.useState(null),k=x.useCallback(()=>{m("input"),N({newItems:[],updatedItems:[],uptodateItems:[]}),u(null)},[]),y=x.useCallback(async()=>{m("analyzing"),u(null);try{const r=await fetch(U);if(!r.ok)throw new Error("Failed to fetch data from Apps Script ("+r.status+")");const o=await r.json();if(o.status==="error")throw new Error(o.message||"Unknown Script Error");const b=Array.isArray(o)?o:o.data||[];if(b.length===0)throw new Error("No data received (Sheet might be empty or Name mismatch)");const g=b.map(t=>({ticketNumber:t.ticketNo||t.ticketNumber||"",shortDesc:t.subject||t.shortDescription||t.description||"",status:t.status||"Open",type:t.ticketType||t.type||"Incident",assign:t.assignee||t.assign||"Unassigned",details:t.description||t.detail||"",action:t.actionTaken||t.action||"",resolvedDetail:t.resolutionNote||t.resolvedDetail||"",remark:t.remark||"",severity:t.severity||"Low",category:t.category||"",subCategory:t.subCategory||"",date:L(t.date||t.ticketDate||t.createdAt),createdAt:L(t.date||t.ticketDate||t.createdAt)})).filter(t=>t.ticketNumber),p=Array.from(g.reduce((t,a)=>{const h=String(a.ticketNumber).trim();return t.set(h,{...a,ticketNumber:h}),t},new Map).values()),D=[],S=[],C=[];p.forEach(t=>{const a=s.find(h=>String(h.ticketNumber).trim()===t.ticketNumber);a?a.status!==t.status||a.shortDesc!==t.shortDesc||a.assign!==t.assign||a.action!==t.action||(a.details||"")!==t.details||(a.remark||"")!==t.remark||(a.type||"Incident")!==t.type||(a.resolvedDetail||"")!==t.resolvedDetail||(a.category||"")!==t.category||(a.subCategory||"")!==t.subCategory||(a.severity||"Low")!==t.severity?S.push({...t,_prev:a}):C.push(t):D.push(t)});const j=(t,a)=>new Date(a.createdAt||0)-new Date(t.createdAt||0);N({newItems:D.sort(j),updatedItems:S.sort(j),uptodateItems:C.sort(j)}),m("review")}catch(r){console.error(r),u("Sync Error: "+r.message),m("input")}},[s]),B=x.useCallback(async()=>{m("saving");try{const o=[...c.newItems,...c.updatedItems].map(({_prev:g,...p})=>p);o.length>0&&await O.importLogsFromSheet(o);const{useSyncStatus:b}=await T(async()=>{const{useSyncStatus:g}=await import("./index-DeB0UNQi.js").then(p=>p.aD);return{useSyncStatus:g}},__vite__mapDeps([0,1]));b.getState().setDone(o.length,!1,"manual"),l&&l(o.length),setTimeout(()=>{n(),k()},1500),m("success")}catch(r){u("Database Error: "+r.message),m("review")}},[c.newItems,c.updatedItems,l,n,k]);if(!i)return null;const z=c.newItems.length+c.updatedItems.length;return e.jsx(P,{isOpen:i,onClose:n,size:"md",showCloseButton:!1,headerClassName:"px-5 py-4 border-b border-zinc-100 dark:border-zinc-800 flex justify-between items-center bg-zinc-50 dark:bg-zinc-900/50",header:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-zinc-900 dark:bg-white rounded-lg",children:e.jsx(E,{size:16,className:"text-white dark:text-zinc-900"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-black text-zinc-900 dark:text-white",children:"Live Sync Manager"}),e.jsx("p",{className:"text-[9px] font-bold text-zinc-400 uppercase tracking-widest mt-0.5",children:"External Database Connector"})]})]}),e.jsx("button",{onClick:n,className:"p-1.5 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg text-zinc-400 transition-colors",children:e.jsx(Y,{size:18})})]}),bodyClassName:"flex-1 overflow-y-auto custom-scrollbar p-5",footerClassName:"shrink-0 px-5 py-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-end gap-2 bg-zinc-50/50 dark:bg-zinc-900/30",footer:e.jsxs(e.Fragment,{children:[d==="input"&&e.jsxs("button",{onClick:y,className:"px-5 py-2 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 rounded-lg text-xs font-bold hover:opacity-90 active:scale-[0.98] transition-all flex items-center gap-2",children:["Fetch & Analyze ",e.jsx(K,{size:14})]}),d==="review"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:k,className:"px-4 py-2 text-xs font-bold text-zinc-500 hover:text-zinc-900 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors",children:"Back"}),e.jsxs("button",{onClick:B,disabled:z===0,className:"px-5 py-2 bg-[#0078D4] text-white rounded-lg text-xs font-bold hover:bg-[#106EBE] active:scale-[0.98] transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(V,{size:14})," Confirm Sync"]})]}),d==="saving"&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 text-xs font-medium text-zinc-400",children:[e.jsx(I,{size:14,className:"animate-spin"})," Updating Database..."]}),d==="success"&&e.jsx("button",{onClick:n,className:"px-4 py-2 text-xs font-bold text-zinc-500 hover:text-zinc-900 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors",children:"Close"})]}),children:e.jsxs(e.Fragment,{children:[d==="input"&&e.jsxs("div",{className:"text-center py-8 animate-in fade-in duration-200",children:[e.jsx("div",{className:"w-12 h-12 bg-[#0078D4]/10 dark:bg-[#0078D4]/20 rounded-lg flex items-center justify-center mx-auto mb-3",children:e.jsx(E,{size:24,className:"text-[#0078D4]"})}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white",children:"Ready to Sync"}),e.jsx("p",{className:"text-xs text-zinc-500 mt-1 max-w-xs mx-auto",children:"Fetch latest tickets from Google Sheets. Review before saving."}),w&&e.jsxs("div",{className:"mt-4 p-2.5 bg-red-50 dark:bg-red-950/30 text-red-600 dark:text-red-400 text-xs font-medium rounded-lg flex items-center gap-2 justify-center",children:[e.jsx(M,{size:14})," ",w]})]}),d==="analyzing"&&e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center text-center animate-in fade-in duration-200",children:[e.jsx(I,{size:32,className:"animate-spin text-[#0078D4] mb-4"}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white",children:"Analyzing Data..."}),e.jsx("p",{className:"text-xs text-zinc-400 mt-1",children:"Comparing Remote vs Database"})]}),d==="review"&&e.jsxs("div",{className:"space-y-4 animate-in fade-in duration-200",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(f,{label:"New",value:c.newItems.length,variant:"new"}),e.jsx(f,{label:"Updates",value:c.updatedItems.length,variant:"update"}),e.jsx(f,{label:"Unchanged",value:c.uptodateItems.length,variant:"unchanged"})]}),z>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-medium text-zinc-500",children:"Pending Sync Records"}),e.jsxs("span",{className:"text-[10px] font-bold text-zinc-400",children:[z," items to process"]})]}),e.jsxs("button",{onClick:y,disabled:d==="analyzing",className:"flex items-center gap-1.5 px-3 py-1.5 bg-zinc-100 dark:bg-zinc-800 rounded-lg text-zinc-500 hover:text-[#0078D4] transition-all font-black text-[9px] uppercase border border-zinc-200/50 dark:border-zinc-700/50 active:scale-95",title:"Re-fetch latest data",children:[e.jsx(A,{size:12,className:d==="analyzing"?"animate-spin":""})," Refresh"]})]}),e.jsx("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 rounded-lg overflow-hidden shadow-inner",children:e.jsxs("div",{className:"max-h-[320px] overflow-y-auto custom-scrollbar divide-y divide-zinc-100 dark:divide-zinc-800",children:[c.newItems.map(r=>e.jsx(v,{item:r,type:"new"},r.ticketNumber)),c.updatedItems.map(r=>e.jsx(v,{item:r,type:"update"},r.ticketNumber))]})})]}):e.jsxs("div",{className:"py-10 text-center border border-dashed border-zinc-200 dark:border-zinc-800 rounded-lg bg-zinc-50/50 dark:bg-zinc-900/30",children:[e.jsx(F,{size:32,className:"mx-auto mb-3 text-emerald-500/40"}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white uppercase tracking-tight",children:"System Synchronized"}),e.jsx("p",{className:"text-[10px] text-zinc-400 mt-1 max-w-[200px] mx-auto leading-relaxed",children:"Your local database matches the remote Google Sheets source."}),e.jsxs("button",{onClick:y,className:"mt-6 flex items-center gap-1.5 px-4 py-2 mx-auto bg-white dark:bg-zinc-800 rounded-lg text-zinc-500 hover:text-[#0078D4] transition-all font-black text-[9px] uppercase border border-zinc-200/50 dark:border-zinc-700/50 active:scale-95 shadow-sm",children:[e.jsx(A,{size:12})," Force Re-Check"]})]})]}),d==="success"&&e.jsxs("div",{className:"py-10 flex flex-col items-center justify-center text-center animate-in zoom-in-95 duration-300",children:[e.jsx("div",{className:"w-14 h-14 bg-emerald-500 rounded-lg flex items-center justify-center text-white mb-4",children:e.jsx(F,{size:28,strokeWidth:2.5})}),e.jsx("h3",{className:"text-lg font-black text-zinc-900 dark:text-white",children:"Sync Complete"}),e.jsx("p",{className:"text-xs text-zinc-400 mt-1",children:"Database updated successfully"})]})]})})}export{ae as default};
