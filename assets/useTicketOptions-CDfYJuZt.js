import{c as M,i as I,k as T,l as F,r as m}from"./index-DK6B-WCw.js";import{i as v,d as n,b as u,q as w,c as h,j as b,g as L,u as p,h as O,s as R,o as f,a as P,l as k,k as C,m as q}from"./firebaseConfig-BlIlsXYa.js";import{Q as _,u as U}from"./useBaseQuery-BujZq4kw.js";import{c as x}from"./configService-CZgy8SXU.js";const B=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]],$=M("shield-alert",B);const j=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],W=M("user",j);var Q=class extends _{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:I()})}getOptimisticResult(e){return e.behavior=I(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){const{state:r}=e,s=super.createResult(e,t),{isFetching:c,isRefetching:o,isError:a,isRefetchError:i}=s,y=r.fetchMeta?.fetchMore?.direction,E=a&&y==="forward",N=c&&y==="forward",D=a&&y==="backward",A=c&&y==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:F(t,r.data),hasPreviousPage:T(t,r.data),isFetchNextPageError:E,isFetchingNextPage:N,isFetchPreviousPageError:D,isFetchingPreviousPage:A,isRefetchError:i&&!E&&!D,isRefetching:o&&!N&&!A}}};function z(e,t){return U(e,Q)}const d="incidents",g="events",Y={subscribeIncidents:(e,t=500)=>{const r=w(h(n,d),f("updatedAt","desc"),k(t));return P(r,s=>{const c=s.docs.map(o=>{const a=o.data();return{id:o.id,...a,status:a.status||"Open",type:a.type||"Incident",project:a.project||"MONOMAX",_sortTime:new Date(a.updatedAt||a.createdAt||0).getTime()}});e(c)},s=>{console.error("Incidents subscription error:",s),e([])})},subscribeEvents:(e,t)=>{const r=w(h(n,d,e,g),f("order","asc"),f("date","desc"),f("time","desc"));return P(r,s=>{const c=s.docs.map(o=>({id:o.id,...o.data(),imageUrls:o.data().imageUrls||[]}));t(c)},s=>{console.error("Events subscription error:",s),t([])})},createIncident:async(e,t=null)=>{try{const r={...e,status:e.status||"Open",type:e.type||"Incident",priority:e.priority||"Medium",project:e.project||"MONOMAX",eventCount:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return t?(await R(u(n,d,t),r),{id:t}):await O(h(n,d),r)}catch(r){throw console.error("Create incident error:",r),new Error("Failed to create incident")}},updateIncident:async(e,t)=>{try{await p(u(n,d,e),{...t,updatedAt:new Date().toISOString()})}catch(r){throw console.error("Update incident error:",r),new Error("Failed to update incident")}},deleteIncident:async e=>{try{const t=h(n,d,e,g),r=await b(t),s=v(n);r.docs.forEach(c=>{s.delete(c.ref)}),s.delete(u(n,d,e)),await s.commit()}catch(t){throw console.error("Delete incident error:",t),new Error("Failed to delete incident")}},createEvent:async(e,t)=>{try{const r=await O(h(n,d,e,g),{...t,order:t.order??-Date.now(),imageUrls:t.imageUrls||[],createdAt:new Date().toISOString()});return await p(u(n,d,e),{updatedAt:new Date().toISOString()}),r}catch(r){throw console.error("Create event error:",r),new Error("Failed to create event")}},updateEvent:async(e,t,r)=>{try{await p(u(n,d,e,g,t),{...r,updatedAt:new Date().toISOString()}),await p(u(n,d,e),{updatedAt:new Date().toISOString()})}catch(s){throw console.error("Update event error:",s),new Error("Failed to update event")}},deleteEvent:async(e,t)=>{try{await L(u(n,d,e,g,t)),await p(u(n,d,e),{updatedAt:new Date().toISOString()})}catch(r){throw console.error("Delete event error:",r),new Error("Failed to delete event")}},getEvents:async e=>{try{const t=w(h(n,d,e,g));return(await b(t)).docs.map(c=>({id:c.id,...c.data()})).sort((c,o)=>{const a=c.date||"1970-01-01",i=o.date||"1970-01-01";return a!==i?a.localeCompare(i):(c.time||"00:00").localeCompare(o.time||"00:00")})}catch(t){return console.error("Get events error:",t),[]}},reorderEvents:async(e,t)=>{try{const r=v(n);t.forEach(s=>{const c=u(n,d,e,g,s.id);r.update(c,{order:s.order})}),await r.commit()}catch(r){throw console.error("Reorder events error:",r),new Error("Failed to reorder events")}}},l="ticket_logs",K="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",S=async(e,t)=>{const r={action:e,ticketNumber:t.ticketNumber,ticketType:t.type??t.ticketType,status:t.status,severity:t.severity,category:t.category??"",subCategory:t.subCategory??"",shortDescription:t.shortDesc!==void 0?t.shortDesc:t.shortDescription,detail:t.details!==void 0?t.details:t.detail,actionTaken:t.action!==void 0?t.action:t.actionTaken,resolvedDetail:t.resolvedDetail??"",assign:t.assign??"",remark:t.remark??""};try{fetch(K,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},V={subscribeLogs:(e,t=50)=>{const r=w(h(n,l),f("createdAt","desc"),k(t));return P(r,s=>{const c=s.docs.map(o=>({id:o.id,...o.data()}));e(c,s.docs[s.docs.length-1])})},fetchMoreLogs:async(e,t=20)=>{try{const r=[f("createdAt","desc"),k(t)];e&&r.push(q(e));const s=w(h(n,l),...r),c=await b(s);return{data:c.docs.map(o=>({id:o.id,...o.data()})),lastDoc:c.docs[c.docs.length-1]||null}}catch{return{data:[],lastDoc:null}}},importLogsFromSheet:async e=>{const r=[];for(let s=0;s<e.length;s+=500)r.push(e.slice(s,s+500));for(const s of r){const c=v(n);s.forEach(o=>{const a=o.ticketNumber?u(n,l,String(o.ticketNumber)):u(h(n,l));c.set(a,{...o,createdAt:o.date?new Date(o.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await c.commit()}return{success:!0,count:e.length}},createLog:async e=>{if(e.ticketNumber){const t=u(n,l,String(e.ticketNumber));if((await C(t)).exists())throw new Error(`Ticket ${e.ticketNumber} exists!`);await R(t,{...e,createdAt:new Date().toISOString()})}else await O(h(n,l),{...e,createdAt:new Date().toISOString()});S("create",e)},updateLog:async(e,t)=>{const r=u(n,l,String(e));await p(r,t),S("update",{ticketNumber:e,...t})},deleteLog:async e=>{const t=u(n,l,String(e));await L(t),S("delete",{ticketNumber:e})}},ee=()=>{const{data:e,fetchNextPage:t,hasNextPage:r,isFetchingNextPage:s,isLoading:c}=z({queryKey:["ticketLogs"],queryFn:async({pageParam:i=null})=>await V.fetchMoreLogs(i),initialPageParam:null,getNextPageParam:i=>i.lastDoc||void 0}),o=e?.pages.flatMap(i=>i.data)||[],a={total:o.length,incidents:o.filter(i=>i.type==="Incident").length,requests:o.filter(i=>i.type==="Request"||i.type==="Service Request").length};return{logs:o,loading:c,loadingMore:s,hasMore:r,loadMore:t,stats:a}};function te(){const[e,t]=m.useState(x.getDefaultTicketOptions()),[r,s]=m.useState(!0);return m.useEffect(()=>{const c=x.subscribeTicketOptions(o=>{t(o),s(!1)});return()=>c()},[]),{ticketOptions:e,loading:r}}export{$ as S,W as U,ee as a,Y as i,V as t,te as u};
