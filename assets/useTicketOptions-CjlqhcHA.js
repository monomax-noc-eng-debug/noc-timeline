import{c as x,m as P,n as w,o as O,r as f}from"./index-B5gZUy_b.js";import{Q as D,u as L}from"./useBaseQuery-Bu4CR-PA.js";import{b as g,g as R,u as M,d as n,i as T,s as E,h as I,c as d,j as A,a as k,l as S,k as q,q as v,m as F,o as B}from"./firebaseConfig-hLvP2kJq.js";import{c as N}from"./configService-Bpcp19QX.js";const _=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],V=x("user",_);var Q=class extends D{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:P()})}getOptimisticResult(e){return e.behavior=P(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){const{state:r}=e,s=super.createResult(e,t),{isFetching:i,isRefetching:c,isError:u,isRefetchError:o}=s,h=r.fetchMeta?.fetchMore?.direction,p=u&&h==="forward",y=i&&h==="forward",m=u&&h==="backward",b=i&&h==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:O(t,r.data),hasPreviousPage:w(t,r.data),isFetchNextPageError:p,isFetchingNextPage:y,isFetchPreviousPageError:m,isFetchingPreviousPage:b,isRefetchError:o&&!p&&!m,isRefetching:c&&!y&&!b}}};function C(e,t){return L(e,Q)}const a="ticket_logs",K="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",l=async(e,t)=>{const r={action:e,ticketNumber:t.ticketNumber,ticketType:t.type??t.ticketType,status:t.status,severity:t.severity,category:t.category??"",subCategory:t.subCategory??"",shortDescription:t.shortDesc!==void 0?t.shortDesc:t.shortDescription,detail:t.details!==void 0?t.details:t.detail,actionTaken:t.action!==void 0?t.action:t.actionTaken,resolvedDetail:t.resolvedDetail??"",assign:t.assign??"",remark:t.remark??""};try{fetch(K,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},U={subscribeLogs:(e,t=50)=>{const r=v(d(n,a),k("createdAt","desc"),S(t));return B(r,s=>{const i=s.docs.map(c=>({id:c.id,...c.data()}));e(i,s.docs[s.docs.length-1])})},fetchMoreLogs:async(e,t=20)=>{try{const r=[k("createdAt","desc"),S(t)];e&&r.push(q(e));const s=v(d(n,a),...r),i=await F(s);return{data:i.docs.map(c=>({id:c.id,...c.data()})),lastDoc:i.docs[i.docs.length-1]||null}}catch{return{data:[],lastDoc:null}}},importLogsFromSheet:async e=>{const r=[];for(let s=0;s<e.length;s+=500)r.push(e.slice(s,s+500));for(const s of r){const i=A(n);s.forEach(c=>{const u=c.ticketNumber?g(n,a,String(c.ticketNumber)):g(d(n,a));i.set(u,{...c,createdAt:c.date?new Date(c.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await i.commit()}return{success:!0,count:e.length}},createLog:async e=>{if(e.ticketNumber){const t=g(n,a,String(e.ticketNumber));if((await T(t)).exists())throw new Error(`Ticket ${e.ticketNumber} exists!`);await E(t,{...e,createdAt:new Date().toISOString()})}else await I(d(n,a),{...e,createdAt:new Date().toISOString()});l("create",e)},updateLog:async(e,t)=>{const r=g(n,a,String(e));await M(r,t),l("update",{ticketNumber:e,...t})},deleteLog:async e=>{const t=g(n,a,String(e));await R(t),l("delete",{ticketNumber:e})}},Z=()=>{const{data:e,fetchNextPage:t,hasNextPage:r,isFetchingNextPage:s,isLoading:i}=C({queryKey:["ticketLogs"],queryFn:async({pageParam:o=null})=>await U.fetchMoreLogs(o),initialPageParam:null,getNextPageParam:o=>o.lastDoc||void 0}),c=e?.pages.flatMap(o=>o.data)||[],u={total:c.length,incidents:c.filter(o=>o.type==="Incident").length,requests:c.filter(o=>o.type==="Request"||o.type==="Service Request").length};return{logs:c,loading:i,loadingMore:s,hasMore:r,loadMore:t,stats:u}};function W(){const[e,t]=f.useState(N.getDefaultTicketOptions()),[r,s]=f.useState(!0);return f.useEffect(()=>{const i=N.subscribeTicketOptions(c=>{t(c),s(!1)});return()=>i()},[]),{ticketOptions:e,loading:r}}export{V as U,Z as a,U as t,W as u};
