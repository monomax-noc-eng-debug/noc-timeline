import{d,u as p,g as h,a as c,f as w,s as x,q as l,i as m,e as v,o as y,j as P,h as E,k as L,w as M,l as D,m as q}from"./firebaseConfig-Cp-1Ewx5.js";import{Q as F,u as B}from"./useBaseQuery-D1z1sIDx.js";import{B as N,E as C,G as Q,r as S}from"./index-DcZD2k9h.js";import{c as A}from"./configService-CpUaQNct.js";var _=class extends F{constructor(t,e){super(t,e)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:N()})}getOptimisticResult(t){return t.behavior=N(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,e){const{state:r}=t,s=super.createResult(t,e),{isFetching:o,isRefetching:n,isError:u,isRefetchError:a}=s,g=r.fetchMeta?.fetchMore?.direction,O=u&&g==="forward",I=o&&g==="forward",R=u&&g==="backward",k=o&&g==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:Q(e,r.data),hasPreviousPage:C(e,r.data),isFetchNextPageError:O,isFetchingNextPage:I,isFetchPreviousPageError:R,isFetchingPreviousPage:k,isRefetchError:a&&!O&&!R,isRefetching:n&&!I&&!k}}};function z(t,e){return B(t,_)}const i="incidents",K=(t,e)=>{if(!c)return console.error("Firebase not configured! Check your .env file"),e&&e(new Error("Firebase not configured")),t([]),()=>{};try{const r=l(h(c,i),y("createdAt","desc"));return E(r,s=>{const o=s.docs.map(n=>({id:n.id,...n.data()}));t(o)},s=>{console.error("Subscription error:",s.message),e&&e(s),t([])})}catch(r){return console.error("Failed to create subscription:",r.message),e&&e(r),t([]),()=>{}}},j=async t=>{try{const e=d(c,i,t),r=await P(e);return r.exists()?{id:r.id,...r.data()}:null}catch(e){throw console.error("Error getting incident:",e),e}},G=async()=>{try{const t=l(h(c,i),y("createdAt","desc"));return(await m(t)).docs.map(r=>({id:r.id,...r.data()}))}catch(t){throw console.error("Error fetching incidents:",t),t}},U=async t=>{try{return(await w(h(c,i),{...t,status:t.status||"Open",priority:t.priority||"Medium",timeline:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),serverTimestamp:x()})).id}catch(e){throw console.error("Error creating incident:",e),e}},J=async(t,e)=>{try{const r=d(c,i,t);await p(r,{...e,updatedAt:new Date().toISOString()})}catch(r){throw console.error("Error updating incident:",r),r}},V=async t=>{try{const e=d(c,i,t);await v(e)}catch(e){throw console.error("Error deleting incident:",e),e}},Z=(t,e)=>{if(!t)return()=>{};const r=h(c,i,t,"events"),s=l(r);return E(s,o=>{const n=o.docs.map(u=>({id:u.id,...u.data()}));e(n)},o=>console.error("Error subscribing to events sub-collection:",o))},T=async(t,e)=>{try{const r=h(c,i,t,"events"),s={...e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},o=await w(r,s),n=d(c,i,t);return await p(n,{updatedAt:x()}),{id:o.id,...s}}catch(r){throw console.error("Error adding event:",r),r}},H=async(t,e,r)=>{try{const s=e.id||r.id;if(!s)throw new Error("Event ID missing for update");const o=d(c,i,t,"events",s),n={...r,updatedAt:new Date().toISOString()};return await p(o,n),{id:s,...n}}catch(s){throw console.error("Error updating event:",s),s}},W=async(t,e)=>{try{const r=e.id;if(!r)throw new Error("Event ID missing for delete");const s=d(c,i,t,"events",r);await v(s)}catch(r){throw console.error("Error deleting event:",r),r}},X=async t=>{try{const e=h(c,i,t,"events");return(await m(e)).docs.map(s=>({id:s.id,...s.data()}))}catch(e){return console.error("Error fetching events:",e),[]}},$=T,Y=async(t,e,r)=>{const s=d(c,i,t,"events",e);await p(s,{...r,updatedAt:new Date().toISOString()})},ee=async(t,e)=>{const r=d(c,i,t,"events",e);await v(r)},te=async(t,e)=>{console.warn("Reorder not fully optimized for sub-collections yet")},re=async t=>{try{let e=0,r=0;for(const s of t){const o=l(h(c,i),where("ticket","==",s.ticket)),n=await m(o),u={...s,updatedAt:new Date().toISOString()};if(n.empty)await w(h(c,i),{...u,createdAt:s.createdAt||new Date().toISOString(),status:s.status||"Open",priority:s.priority||"Medium",timeline:[]}),e++;else{const a=n.docs[0].id,g=d(c,i,a);await p(g,u),r++}}return{created:e,updated:r}}catch(e){throw console.error("Import Error:",e),e}},ue={subscribeIncidents:K,subscribeEvents:Z,getIncidentById:j,getIncidents:G,createIncident:U,updateIncident:J,deleteIncident:V,addTimelineEvent:T,updateTimelineEvent:H,deleteTimelineEvent:W,getEvents:X,createEvent:$,updateEvent:Y,deleteEvent:ee,reorderEvents:te,importIncidentsFromSheet:re},f="ticket_logs",se="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",b=async(t,e)=>{const r={action:t,ticketNumber:e.ticketNumber||e.id||"",ticketType:e.type||e.ticketType||"",status:e.status||"",severity:e.severity||"",category:e.category||"",subCategory:e.subCategory||"",shortDescription:e.shortDesc||e.shortDescription||"",detail:e.details||e.detail||"",actionTaken:e.action||e.actionTaken||"",resolvedDetail:e.resolvedDetail||"",responsibility:e.responsibility||"",assign:e.assign||"",remark:e.remark||"",date:e.createdAt||e.date||""};try{fetch(se,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},ne={subscribeLogs:(t,e=50)=>{const r=l(h(c,f),y("createdAt","desc"),D(e));return E(r,s=>{const o=s.docs.map(n=>({id:n.id,...n.data()}));t(o,s.docs[s.docs.length-1])})},fetchMoreLogs:async(t,e=20)=>{try{const r=[y("createdAt","desc"),D(e)];t&&r.push(q(t));const s=l(h(c,f),...r),o=await m(s);return{data:o.docs.map(n=>({id:n.id,...n.data()})),lastDoc:o.docs[o.docs.length-1]||null}}catch{return{data:[],lastDoc:null}}},importLogsFromSheet:async t=>{const r=[];for(let s=0;s<t.length;s+=500)r.push(t.slice(s,s+500));for(const s of r){const o=M(c);s.forEach(n=>{const u=n.ticketNumber?d(c,f,String(n.ticketNumber)):d(h(c,f));o.set(u,{...n,createdAt:n.date?new Date(n.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await o.commit()}return{success:!0,count:t.length}},createLog:async t=>{if(t.ticketNumber){const e=d(c,f,String(t.ticketNumber));if((await P(e)).exists())throw new Error(`Ticket ${t.ticketNumber} exists!`);await L(e,{...t,createdAt:new Date().toISOString()})}else await w(h(c,f),{...t,createdAt:new Date().toISOString()});b("create",t)},updateLog:async(t,e)=>{const r=d(c,f,String(t));await p(r,e);const s=await P(r);if(s.exists()){const o={ticketNumber:t,...s.data()};b("update",o)}},deleteLog:async t=>{const e=d(c,f,String(t));await v(e),b("delete",{ticketNumber:t})}},he=()=>{const{data:t,fetchNextPage:e,hasNextPage:r,isFetchingNextPage:s,isLoading:o}=z({queryKey:["ticketLogs"],queryFn:async({pageParam:a=null})=>await ne.fetchMoreLogs(a),initialPageParam:null,getNextPageParam:a=>a.lastDoc||void 0}),n=t?.pages.flatMap(a=>a.data)||[],u={total:n.length,incidents:n.filter(a=>a.type==="Incident").length,requests:n.filter(a=>a.type==="Request"||a.type==="Service Request").length};return{logs:n,loading:o,loadingMore:s,hasMore:r,loadMore:e,stats:u}};function fe(){const[t,e]=S.useState(A.getDefaultTicketOptions()),[r,s]=S.useState(!0);return S.useEffect(()=>{const o=A.subscribeTicketOptions(n=>{e(n),s(!1)});return()=>o()},[]),{ticketOptions:t,loading:r}}export{he as a,ue as i,ne as t,fe as u};
