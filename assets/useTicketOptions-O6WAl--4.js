const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/papaparse.min-CW2clUjE.js","assets/index-C3czKcPY.js","assets/index-ltZyuBV8.css","assets/index-CHpj4Qey.js","assets/addYears-Wkomck9s.js","assets/format-DPgh7KlH.js","assets/subMonths-Crx8DVYp.js","assets/setYear-850W9rN9.js","assets/isSameMinute-tCsMbrUw.js","assets/parse-Bm-acfNC.js"])))=>i.map(i=>d[i]);
import{d as _,S as v,T as E,V as I,k as y,h as i,n as P,_ as N,K as x,m as R,l as F,t as O,D as B,f as C,g as b,o as M,v as A,W as V,q as L,i as q,p as K,r as D}from"./index-C3czKcPY.js";import{Q as z,u as j}from"./useBaseQuery-C-SPIq1p.js";import{c as T}from"./configService-BE8VHHI1.js";const H=[["path",{d:"M10 5H3",key:"1qgfaw"}],["path",{d:"M12 19H3",key:"yhmn1j"}],["path",{d:"M14 3v4",key:"1sua03"}],["path",{d:"M16 17v4",key:"1q0r14"}],["path",{d:"M21 12h-9",key:"1o4lsq"}],["path",{d:"M21 19h-5",key:"1rlt1p"}],["path",{d:"M21 5h-7",key:"1oszz2"}],["path",{d:"M8 10v4",key:"tgpxqk"}],["path",{d:"M8 12H3",key:"a7s4jb"}]],$=_("sliders-horizontal",H);var Q=class extends z{constructor(t,e){super(t,e)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:v()})}getOptimisticResult(t){return t.behavior=v(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,e){const{state:c}=t,s=super.createResult(t,e),{isFetching:a,isRefetching:o,isError:d,isRefetchError:n}=s,g=c.fetchMeta?.fetchMore?.direction,p=d&&g==="forward",l=a&&g==="forward",f=d&&g==="backward",r=a&&g==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:I(e,c.data),hasPreviousPage:E(e,c.data),isFetchNextPageError:p,isFetchingNextPage:l,isFetchPreviousPageError:f,isFetchingPreviousPage:r,isRefetchError:n&&!p&&!f,isRefetching:o&&!l&&!r}}};function U(t,e){return j(t,Q)}const u="ticket_logs",Z="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",w=async(t,e)=>{const c={action:t,ticketNumber:e.ticketNumber||e.id||"",ticketType:e.type||e.ticketType||"",status:e.status||"",severity:e.severity||"",category:e.category||"",subCategory:e.subCategory||"",shortDescription:e.shortDesc||e.shortDescription||"",detail:e.details||e.detail||"",actionTaken:e.action||e.actionTaken||"",resolvedDetail:e.resolvedDetail||"",responsibility:e.responsibility||"",assign:e.assign||"",remark:e.remark||"",date:e.createdAt||e.date||""};try{fetch(Z,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(c)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},G={subscribeLogs:(t,e=50)=>{const c=L(b(i,u),M("createdAt","desc"),A(e));return K(c,s=>{const a=s.docs.map(o=>({id:o.id,...o.data()}));t(a,s.docs[s.docs.length-1])})},fetchMoreLogs:async(t,e=20)=>{try{const c=[M("createdAt","desc"),A(e)];t&&c.push(V(t));const s=L(b(i,u),...c),a=await q(s);return{data:a.docs.map(o=>({id:o.id,...o.data()})),lastDoc:a.docs[a.docs.length-1]||null}}catch(c){O(c)}},importLogsFromSheet:async t=>{const c=[];for(let s=0;s<t.length;s+=500)c.push(t.slice(s,s+500));for(const s of c){const a=x(i);s.forEach(o=>{const d=o.ticketNumber?y(i,u,String(o.ticketNumber)):y(b(i,u));a.set(d,{...o,createdAt:o.date?new Date(o.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await a.commit()}return{success:!0,count:t.length}},createLog:async t=>{if(t.ticketNumber){const e=y(i,u,String(t.ticketNumber));(await P(e)).exists()&&O({code:"custom/ticket-exists",message:`Ticket ${t.ticketNumber} exists!`}),await B(e,{...t,createdAt:new Date().toISOString()})}else await C(b(i,u),{...t,createdAt:new Date().toISOString()});w("create",t)},updateLog:async(t,e)=>{const c=y(i,u,String(t));await F(c,e);const s=await P(c);if(s.exists()){const a={ticketNumber:t,...s.data()};w("update",a)}},deleteLog:async t=>{const e=y(i,u,String(t));await R(e),w("delete",{ticketNumber:t})},checkAndSyncTickets:async()=>{try{console.log("[AutoSync] Checking sync status...");const t=y(i,"system_settings","sync_log"),e=await P(t),c=new Date().toISOString().split("T")[0];if(e.exists()&&e.data().lastSyncDate===c){console.log("[AutoSync] Already synced today. Skipping.");return}console.log("[AutoSync] Fetching CSV...");const s=await fetch("https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec");if(!s.ok)throw new Error("Failed to fetch CSV");const a=await s.text(),o=await N(()=>import("./papaparse.min-CW2clUjE.js").then(r=>r.p),__vite__mapDeps([0,1,2])),{parse:d,isValid:n}=await N(async()=>{const{parse:r,isValid:h}=await import("./index-CHpj4Qey.js");return{parse:r,isValid:h}},__vite__mapDeps([3,4,5,6,7,8,9])),g=o.default.parse(a,{header:!0,skipEmptyLines:!0,transformHeader:r=>r.trim()}),p=r=>{if(!r||typeof r!="string")return null;const h=["d/M/yyyy","yyyy-MM-dd","dd/MM/yy","dd/MM/yyyy"],k=new Date;for(const m of h){const S=d(r.trim(),m,k);if(n(S))return S.toISOString()}return null},l=x(i);let f=0;g.data.forEach(r=>{const h=r["Ticket Number"]||r["Ticket No"];if(!h)return;const k=p(r.Date)||new Date().toISOString(),m=y(i,u,String(h)),S={ticketNumber:h,shortDesc:r["Short Description & Detail"]||r.Detail||r.Description||"",status:r.Status||"Open",type:r["Ticket Type"]||"Incident",assign:r.Assign||"Unassigned",details:r.Detail||"",action:r.Ation||r.Action||"",resolvedDetail:r["Resolved detail"]||"",remark:r.Remark||"",date:k,createdAt:k,importedAt:new Date().toISOString()};l.set(m,S,{merge:!0}),f++}),l.set(t,{lastSyncDate:c},{merge:!0}),f>0?(await l.commit(),console.log(`[AutoSync] Successfully synced ${f} tickets.`)):(await l.commit(),console.log("[AutoSync] No new ticket updates found, but sync lock updated."))}catch(t){console.error("[AutoSync] Error:",t)}}},Y=()=>{const{data:t,fetchNextPage:e,hasNextPage:c,isFetchingNextPage:s,isLoading:a}=U({queryKey:["ticketLogs"],queryFn:async({pageParam:n=null})=>await G.fetchMoreLogs(n),initialPageParam:null,getNextPageParam:n=>n.lastDoc||void 0}),o=t?.pages.flatMap(n=>n.data)||[],d={total:o.length,succeed:o.filter(n=>n.status?.toLowerCase()==="succeed").length,pending:o.filter(n=>n.status?.toLowerCase()==="pending").length,incidents:o.filter(n=>n.status?.toLowerCase()==="open"||n.type==="Incident").length};return{logs:o,loading:a,loadingMore:s,hasMore:c,loadMore:e,stats:d}};function tt(){const[t,e]=D.useState(T.getDefaultTicketOptions()),[c,s]=D.useState(!0);return D.useEffect(()=>{const a=T.subscribeTicketOptions(o=>{e(o),s(!1)});return()=>a()},[]),{ticketOptions:t,loading:c}}export{$ as S,Y as a,G as t,tt as u};
