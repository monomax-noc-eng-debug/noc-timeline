import{Q as O,u as D}from"./useBaseQuery-DdGex9By.js";import{a5 as P,a6 as L,a7 as R,V as g,$ as T,W as E,a8 as k,h as a,_ as S,a9 as M,a0 as A,f as d,aa as I,g as N,l as x,ab as F,q as v,ac as q,o as B,r as f}from"./index-Q34mk0jU.js";import{c as w}from"./configService-DFdTgGxv.js";var Q=class extends O{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:P()})}getOptimisticResult(e){return e.behavior=P(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){const{state:r}=e,s=super.createResult(e,t),{isFetching:i,isRefetching:c,isError:u,isRefetchError:o}=s,h=r.fetchMeta?.fetchMore?.direction,p=u&&h==="forward",y=i&&h==="forward",b=u&&h==="backward",m=i&&h==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:R(t,r.data),hasPreviousPage:L(t,r.data),isFetchNextPageError:p,isFetchingNextPage:y,isFetchPreviousPageError:b,isFetchingPreviousPage:m,isRefetchError:o&&!p&&!b,isRefetching:c&&!y&&!m}}};function _(e,t){return D(e,Q)}const n="ticket_logs",C="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",l=async(e,t)=>{const r={action:e,ticketNumber:t.ticketNumber||t.id||"",ticketType:t.type||t.ticketType||"",status:t.status||"",severity:t.severity||"",category:t.category||"",subCategory:t.subCategory||"",shortDescription:t.shortDesc||t.shortDescription||"",detail:t.details||t.detail||"",actionTaken:t.action||t.actionTaken||"",resolvedDetail:t.resolvedDetail||"",responsibility:t.responsibility||"",assign:t.assign||"",remark:t.remark||"",date:t.createdAt||t.date||""};try{fetch(C,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},K={subscribeLogs:(e,t=50)=>{const r=v(d(a,n),N("createdAt","desc"),x(t));return B(r,s=>{const i=s.docs.map(c=>({id:c.id,...c.data()}));e(i,s.docs[s.docs.length-1])})},fetchMoreLogs:async(e,t=20)=>{try{const r=[N("createdAt","desc"),x(t)];e&&r.push(F(e));const s=v(d(a,n),...r),i=await q(s);return{data:i.docs.map(c=>({id:c.id,...c.data()})),lastDoc:i.docs[i.docs.length-1]||null}}catch(r){S(r)}},importLogsFromSheet:async e=>{const r=[];for(let s=0;s<e.length;s+=500)r.push(e.slice(s,s+500));for(const s of r){const i=I(a);s.forEach(c=>{const u=c.ticketNumber?g(a,n,String(c.ticketNumber)):g(d(a,n));i.set(u,{...c,createdAt:c.date?new Date(c.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await i.commit()}return{success:!0,count:e.length}},createLog:async e=>{if(e.ticketNumber){const t=g(a,n,String(e.ticketNumber));(await k(t)).exists()&&S({code:"custom/ticket-exists",message:`Ticket ${e.ticketNumber} exists!`}),await M(t,{...e,createdAt:new Date().toISOString()})}else await A(d(a,n),{...e,createdAt:new Date().toISOString()});l("create",e)},updateLog:async(e,t)=>{const r=g(a,n,String(e));await E(r,t);const s=await k(r);if(s.exists()){const i={ticketNumber:e,...s.data()};l("update",i)}},deleteLog:async e=>{const t=g(a,n,String(e));await T(t),l("delete",{ticketNumber:e})}},G=()=>{const{data:e,fetchNextPage:t,hasNextPage:r,isFetchingNextPage:s,isLoading:i}=_({queryKey:["ticketLogs"],queryFn:async({pageParam:o=null})=>await K.fetchMoreLogs(o),initialPageParam:null,getNextPageParam:o=>o.lastDoc||void 0}),c=e?.pages.flatMap(o=>o.data)||[],u={total:c.length,incidents:c.filter(o=>o.type==="Incident").length,requests:c.filter(o=>o.type==="Request"||o.type==="Service Request").length};return{logs:c,loading:i,loadingMore:s,hasMore:r,loadMore:t,stats:u}};function J(){const[e,t]=f.useState(w.getDefaultTicketOptions()),[r,s]=f.useState(!0);return f.useEffect(()=>{const i=w.subscribeTicketOptions(c=>{t(c),s(!1)});return()=>i()},[]),{ticketOptions:e,loading:r}}export{G as a,K as t,J as u};
