const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BFEWtwhJ.js","assets/index-CVhFeo2U.css","assets/papaparse.min-Dv0qVUJi.js","assets/index-B6h196zp.js","assets/addYears-C7ezsmVv.js","assets/format-DU8rxv2E.js","assets/setYear-BV4xPqlg.js","assets/parse-ChHvz_2n.js"])))=>i.map(i=>d[i]);
import{d as I,Q as v,S as M,T as E,_ as D,g as d,f as i,p as P,w as O,n as R,m as F,H as x,i as N,o as L,x as A,V,q as T,l as C,t as B,v as q}from"./index-BFEWtwhJ.js";import{Q as K,u as Q}from"./useBaseQuery-BL-GicvM.js";const z=[["path",{d:"M4 22V4a1 1 0 0 1 .4-.8A6 6 0 0 1 8 2c3 0 5 2 7.333 2q2 0 3.067-.8A1 1 0 0 1 20 4v10a1 1 0 0 1-.4.8A6 6 0 0 1 16 16c-3 0-5-2-8-2a6 6 0 0 0-4 1.528",key:"1jaruq"}]],X=I("flag",z);const U=[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]],$=I("inbox",U);var j=class extends K{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:v()})}getOptimisticResult(e){return e.behavior=v(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){const{state:r}=e,s=super.createResult(e,t),{isFetching:n,isRefetching:a,isError:u,isRefetchError:o}=s,h=r.fetchMeta?.fetchMore?.direction,p=u&&h==="forward",S=n&&h==="forward",m=u&&h==="backward",l=n&&h==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:E(t,r.data),hasPreviousPage:M(t,r.data),isFetchNextPageError:p,isFetchingNextPage:S,isFetchPreviousPageError:m,isFetchingPreviousPage:l,isRefetchError:o&&!p&&!m,isRefetching:a&&!S&&!l}}};function H(e,t){return Q(e,j)}const g="ticket_logs",Z="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",_=async(e,t)=>{const r={action:e,ticketNumber:t.ticketNumber||t.id||"",ticketType:t.type||t.ticketType||"",status:t.status||"",severity:t.severity||"",category:t.category||"",subCategory:t.subCategory||"",shortDescription:t.shortDesc||t.shortDescription||"",detail:t.details||t.detail||"",actionTaken:t.action||t.actionTaken||"",resolvedDetail:t.resolvedDetail||"",responsibility:t.responsibility||"",assign:t.assign||"",remark:t.remark||"",date:t.createdAt||t.date||""};try{fetch(Z,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},G={subscribeLogs:(e,t=50)=>{const r=T(N(i,g),L("createdAt","desc"),A(t));return q(r,s=>{const n=s.docs.map(a=>({id:a.id,ticketNumber:a.id,...a.data()}));e(n,s.docs[s.docs.length-1])})},fetchMoreLogs:async(e,t=20)=>{try{const r=[L("createdAt","desc"),A(t)];e&&r.push(V(e));const s=T(N(i,g),...r),n=await C(s);return{data:n.docs.map(a=>({id:a.id,ticketNumber:a.id,...a.data()})),lastDoc:n.docs[n.docs.length-1]||null}}catch(r){B(r)}},importLogsFromSheet:async e=>{const r=[];for(let s=0;s<e.length;s+=500)r.push(e.slice(s,s+500));for(const s of r){const n=O(i);s.forEach(a=>{const u=a.ticketNumber?d(i,g,String(a.ticketNumber)):d(N(i,g));n.set(u,{...a,createdAt:a.date?new Date(a.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await n.commit()}try{const s=new Date().toISOString().split("T")[0],n=d(i,"system_settings","sync_log");await x(n,{lastSyncDate:s,lastManualSync:new Date().toISOString(),lastSyncType:"manual",updatedCount:e.length},{merge:!0})}catch(s){console.error("Failed to update sync log:",s)}return{success:!0,count:e.length}},createLog:async e=>{if(!e.ticketNumber||e.ticketNumber.trim()==="")throw new Error("Ticket Number is required");const t=String(e.ticketNumber).trim(),r=d(i,g,t);if((await P(r)).exists())throw new Error(`Ticket #${t} already exists! Please use a different ticket number.`);await x(r,{...e,ticketNumber:t,createdAt:new Date().toISOString()}),_("create",{...e,ticketNumber:t})},updateLog:async(e,t)=>{const r=d(i,g,String(e));await F(r,t);const s=await P(r);if(s.exists()){const n={ticketNumber:e,...s.data()};_("update",n)}},deleteLog:async e=>{const t=d(i,g,String(e));await R(t),_("delete",{ticketNumber:e})},checkAndSyncTickets:async()=>{const{useSyncStatus:e}=await D(async()=>{const{useSyncStatus:r}=await import("./index-BFEWtwhJ.js").then(s=>s.aA);return{useSyncStatus:r}},__vite__mapDeps([0,1])),t=e.getState();try{t.setChecking();const r=d(i,"system_settings","sync_log"),s=await P(r),n=new Date().toISOString().split("T")[0];if(s.exists()&&s.data().lastSyncDate===n)return t.setDone(0,!0),{synced:!1,reason:"already_synced"};t.setSyncing();const a=await fetch("https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec");if(!a.ok)throw new Error("Failed to fetch CSV");const u=await a.text(),o=await D(()=>import("./papaparse.min-Dv0qVUJi.js").then(c=>c.p),__vite__mapDeps([2,0,1])),{parse:h,isValid:p}=await D(async()=>{const{parse:c,isValid:y}=await import("./index-B6h196zp.js");return{parse:c,isValid:y}},__vite__mapDeps([3,4,5,6,7])),S=o.default.parse(u,{header:!0,skipEmptyLines:!0,transformHeader:c=>c.trim()}),m=c=>{if(!c||typeof c!="string")return null;const y=["d/M/yyyy","yyyy-MM-dd","dd/MM/yy","dd/MM/yyyy"],b=new Date;for(const k of y){const w=h(c.trim(),k,b);if(p(w))return w.toISOString()}return null},l=O(i);let f=0;return S.data.forEach(c=>{const y=c["Ticket Number"]||c["Ticket No"];if(!y)return;const b=m(c.Date)||new Date().toISOString(),k=d(i,g,String(y)),w={ticketNumber:y,shortDesc:c["Short Description & Detail"]||c.Detail||c.Description||"",status:c.Status||"Open",type:c["Ticket Type"]||"Incident",assign:c.Assign||"Unassigned",details:c.Detail||"",action:c.Ation||c.Action||"",resolvedDetail:c["Resolved detail"]||"",remark:c.Remark||"",date:b,createdAt:b,importedAt:new Date().toISOString()};l.set(k,w,{merge:!0}),f++}),l.set(r,{lastSyncDate:n,lastManualSync:new Date().toISOString(),lastSyncType:"auto",updatedCount:f},{merge:!0}),await l.commit(),t.setDone(f,!1),{synced:!0,count:f}}catch(r){const{useSyncStatus:s}=await D(async()=>{const{useSyncStatus:n}=await import("./index-BFEWtwhJ.js").then(a=>a.aA);return{useSyncStatus:n}},__vite__mapDeps([0,1]));return s.getState().setError(r.message),{synced:!1,reason:"error",error:r.message}}}},Y=()=>{const{data:e,fetchNextPage:t,hasNextPage:r,isFetchingNextPage:s,isLoading:n}=H({queryKey:["ticketLogs"],queryFn:async({pageParam:o=null})=>await G.fetchMoreLogs(o),initialPageParam:null,getNextPageParam:o=>o.lastDoc||void 0,staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,refetchOnMount:!1}),a=e?.pages.flatMap(o=>o.data)||[],u={total:a.length,succeed:a.filter(o=>o.status?.toLowerCase()==="succeed").length,pending:a.filter(o=>o.status?.toLowerCase()==="pending").length,incidents:a.filter(o=>o.status?.toLowerCase()==="open"||o.type==="Incident").length};return{logs:a,loading:n,loadingMore:s,hasMore:r,loadMore:t,stats:u}};export{X as F,$ as I,G as t,Y as u};
