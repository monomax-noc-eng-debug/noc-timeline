import{r as x,j as e,F as T,C as M,L as C,R as I,X as P}from"./index-CDkxVpyL.js";import{t as Y}from"./useTicketOptions-1NENMkK8.js";import{C as A}from"./cloud-download-DYvcTZAJ.js";import{C as F}from"./sliders-horizontal-USruKLC5.js";import{A as _}from"./arrow-right-6xxmCear.js";import{D as K}from"./database-DONJxXxF.js";import{p as E}from"./parse-ChHvz_2n.js";import{i as R}from"./format-DU8rxv2E.js";import{a as G}from"./addYears-C7ezsmVv.js";import"./useBaseQuery-CcOuYnM9.js";import"./configService-BD4Z94ql.js";const U="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",B=i=>{if(!i)return new Date().toISOString();const n=new Date(i);if(!isNaN(n.getTime()))return n.toISOString();const o=String(i).trim();let s=E(o,"d/M/yy",new Date);return R(s)?(s.getFullYear()<2e3&&(s=G(s,100),s.getFullYear()<2e3&&s.setFullYear(2e3+parseInt(o.split(/[-/]/)[2]))),s.toISOString()):(s=E(o,"d/M/yyyy",new Date),R(s)?s.toISOString():new Date().toISOString())},b=x.memo(({label:i,value:n,variant:o})=>{const s={new:"bg-emerald-50 dark:bg-emerald-950/30 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-900/50",update:"bg-amber-50 dark:bg-amber-950/30 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-900/50",unchanged:"bg-zinc-50 dark:bg-zinc-900/50 text-zinc-500 border-zinc-200 dark:border-zinc-800"};return e.jsxs("div",{className:`px-3 py-2.5 rounded-lg border text-center ${s[o]}`,children:[e.jsx("span",{className:"text-xl font-black block",children:n}),e.jsx("span",{className:"text-[8px] font-bold uppercase tracking-wider opacity-70",children:i})]})});b.displayName="StatBox";const j=x.memo(({item:i,type:n})=>e.jsxs("div",{className:"px-3 py-2 flex items-center justify-between hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:`w-0.5 h-5 rounded-full shrink-0 ${n==="new"?"bg-emerald-500":"bg-amber-500"}`}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-xs font-bold text-zinc-800 dark:text-zinc-100 truncate",children:["#",i.ticketNumber]}),e.jsx("div",{className:"text-[10px] text-zinc-400 truncate",children:i.shortDesc})]})]}),e.jsx("span",{className:`shrink-0 px-1.5 py-0.5 rounded text-[7px] font-bold uppercase ${n==="new"?"bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-400":"bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400"}`,children:n==="new"?"New":"Update"})]}));j.displayName="PreviewRow";function ae({isOpen:i,onClose:n,onSyncComplete:o,currentLogs:s}){const[d,m]=x.useState("input"),[c,v]=x.useState({newItems:[],updatedItems:[],uptodateItems:[]}),[N,h]=x.useState(null),u=x.useCallback(()=>{m("input"),v({newItems:[],updatedItems:[],uptodateItems:[]}),h(null)},[]),g=x.useCallback(async()=>{m("analyzing"),h(null);try{const r=await fetch(U);if(!r.ok)throw new Error("Failed to fetch data from Apps Script ("+r.status+")");const l=await r.json();if(l.status==="error")throw new Error(l.message||"Unknown Script Error");const k=Array.isArray(l)?l:l.data||[];if(k.length===0)throw new Error("No data received (Sheet might be empty or Name mismatch)");const y=k.map(t=>({ticketNumber:t.ticketNo||t.ticketNumber||"",shortDesc:t.subject||t.shortDescription||t.description||"",status:t.status||"Open",type:t.ticketType||t.type||"Incident",assign:t.assignee||t.assign||"Unassigned",details:t.description||t.detail||"",action:t.actionTaken||t.action||"",resolvedDetail:t.resolutionNote||t.resolvedDetail||"",remark:t.remark||"",severity:t.severity||"Low",category:t.category||"",subCategory:t.subCategory||"",date:B(t.date||t.ticketDate||t.createdAt),createdAt:B(t.date||t.ticketDate||t.createdAt)})).filter(t=>t.ticketNumber),O=Array.from(y.reduce((t,a)=>{const p=String(a.ticketNumber).trim();return t.set(p,{...a,ticketNumber:p}),t},new Map).values()),w=[],D=[],S=[];O.forEach(t=>{const a=s.find(p=>String(p.ticketNumber).trim()===t.ticketNumber);a?a.status!==t.status||a.shortDesc!==t.shortDesc||a.assign!==t.assign||a.action!==t.action||(a.details||"")!==t.details||(a.remark||"")!==t.remark||(a.type||"Incident")!==t.type||(a.resolvedDetail||"")!==t.resolvedDetail||(a.category||"")!==t.category||(a.subCategory||"")!==t.subCategory||(a.severity||"Low")!==t.severity?D.push({...t,_prev:a}):S.push(t):w.push(t)});const z=(t,a)=>new Date(a.createdAt||0)-new Date(t.createdAt||0);v({newItems:w.sort(z),updatedItems:D.sort(z),uptodateItems:S.sort(z)}),m("review")}catch(r){console.error(r),h("Sync Error: "+r.message),m("input")}},[s]),L=x.useCallback(async()=>{m("saving");try{const l=[...c.newItems,...c.updatedItems].map(({_prev:k,...y})=>y);l.length>0&&await Y.importLogsFromSheet(l),o&&o(l.length),setTimeout(()=>{n(),u()},1500),m("success")}catch(r){h("Database Error: "+r.message),m("review")}},[c.newItems,c.updatedItems,o,n,u]);if(!i)return null;const f=c.newItems.length+c.updatedItems.length;return e.jsx(T,{isOpen:i,onClose:n,size:"md",showCloseButton:!1,headerClassName:"px-5 py-4 border-b border-zinc-100 dark:border-zinc-800 flex justify-between items-center bg-zinc-50 dark:bg-zinc-900/50",header:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-zinc-900 dark:bg-white rounded-lg",children:e.jsx(A,{size:16,className:"text-white dark:text-zinc-900"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-black text-zinc-900 dark:text-white",children:"Live Sync Manager"}),e.jsx("p",{className:"text-[9px] font-bold text-zinc-400 uppercase tracking-widest mt-0.5",children:"External Database Connector"})]})]}),e.jsx("button",{onClick:n,className:"p-1.5 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg text-zinc-400 transition-colors",children:e.jsx(P,{size:18})})]}),bodyClassName:"flex-1 overflow-y-auto custom-scrollbar p-5",footerClassName:"shrink-0 px-5 py-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-end gap-2 bg-zinc-50/50 dark:bg-zinc-900/30",footer:e.jsxs(e.Fragment,{children:[d==="input"&&e.jsxs("button",{onClick:g,className:"px-5 py-2 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 rounded-lg text-xs font-bold hover:opacity-90 active:scale-[0.98] transition-all flex items-center gap-2",children:["Fetch & Analyze ",e.jsx(_,{size:14})]}),d==="review"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:u,className:"px-4 py-2 text-xs font-bold text-zinc-500 hover:text-zinc-900 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors",children:"Back"}),e.jsxs("button",{onClick:L,disabled:f===0,className:"px-5 py-2 bg-[#0078D4] text-white rounded-lg text-xs font-bold hover:bg-[#106EBE] active:scale-[0.98] transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(K,{size:14})," Confirm Sync"]})]}),d==="saving"&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 text-xs font-medium text-zinc-400",children:[e.jsx(C,{size:14,className:"animate-spin"})," Updating Database..."]}),d==="success"&&e.jsx("button",{onClick:n,className:"px-4 py-2 text-xs font-bold text-zinc-500 hover:text-zinc-900 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors",children:"Close"})]}),children:e.jsxs(e.Fragment,{children:[d==="input"&&e.jsxs("div",{className:"text-center py-8 animate-in fade-in duration-200",children:[e.jsx("div",{className:"w-12 h-12 bg-[#0078D4]/10 dark:bg-[#0078D4]/20 rounded-lg flex items-center justify-center mx-auto mb-3",children:e.jsx(A,{size:24,className:"text-[#0078D4]"})}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white",children:"Ready to Sync"}),e.jsx("p",{className:"text-xs text-zinc-500 mt-1 max-w-xs mx-auto",children:"Fetch latest tickets from Google Sheets. Review before saving."}),N&&e.jsxs("div",{className:"mt-4 p-2.5 bg-red-50 dark:bg-red-950/30 text-red-600 dark:text-red-400 text-xs font-medium rounded-lg flex items-center gap-2 justify-center",children:[e.jsx(M,{size:14})," ",N]})]}),d==="analyzing"&&e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center text-center animate-in fade-in duration-200",children:[e.jsx(C,{size:32,className:"animate-spin text-[#0078D4] mb-4"}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white",children:"Analyzing Data..."}),e.jsx("p",{className:"text-xs text-zinc-400 mt-1",children:"Comparing Remote vs Database"})]}),d==="review"&&e.jsxs("div",{className:"space-y-4 animate-in fade-in duration-200",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(b,{label:"New",value:c.newItems.length,variant:"new"}),e.jsx(b,{label:"Updates",value:c.updatedItems.length,variant:"update"}),e.jsx(b,{label:"Unchanged",value:c.uptodateItems.length,variant:"unchanged"})]}),f>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-medium text-zinc-500",children:"Pending Sync Records"}),e.jsxs("span",{className:"text-[10px] font-bold text-zinc-400",children:[f," items to process"]})]}),e.jsxs("button",{onClick:g,disabled:d==="analyzing",className:"flex items-center gap-1.5 px-3 py-1.5 bg-zinc-100 dark:bg-zinc-800 rounded-lg text-zinc-500 hover:text-[#0078D4] transition-all font-black text-[9px] uppercase border border-zinc-200/50 dark:border-zinc-700/50 active:scale-95",title:"Re-fetch latest data",children:[e.jsx(I,{size:12,className:d==="analyzing"?"animate-spin":""})," Refresh"]})]}),e.jsx("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 rounded-lg overflow-hidden shadow-inner",children:e.jsxs("div",{className:"max-h-[320px] overflow-y-auto custom-scrollbar divide-y divide-zinc-100 dark:divide-zinc-800",children:[c.newItems.map(r=>e.jsx(j,{item:r,type:"new"},r.ticketNumber)),c.updatedItems.map(r=>e.jsx(j,{item:r,type:"update"},r.ticketNumber))]})})]}):e.jsxs("div",{className:"py-10 text-center border border-dashed border-zinc-200 dark:border-zinc-800 rounded-lg bg-zinc-50/50 dark:bg-zinc-900/30",children:[e.jsx(F,{size:32,className:"mx-auto mb-3 text-emerald-500/40"}),e.jsx("h3",{className:"text-sm font-bold text-zinc-900 dark:text-white uppercase tracking-tight",children:"System Synchronized"}),e.jsx("p",{className:"text-[10px] text-zinc-400 mt-1 max-w-[200px] mx-auto leading-relaxed",children:"Your local database matches the remote Google Sheets source."}),e.jsxs("button",{onClick:g,className:"mt-6 flex items-center gap-1.5 px-4 py-2 mx-auto bg-white dark:bg-zinc-800 rounded-lg text-zinc-500 hover:text-[#0078D4] transition-all font-black text-[9px] uppercase border border-zinc-200/50 dark:border-zinc-700/50 active:scale-95 shadow-sm",children:[e.jsx(I,{size:12})," Force Re-Check"]})]})]}),d==="success"&&e.jsxs("div",{className:"py-10 flex flex-col items-center justify-center text-center animate-in zoom-in-95 duration-300",children:[e.jsx("div",{className:"w-14 h-14 bg-emerald-500 rounded-lg flex items-center justify-center text-white mb-4",children:e.jsx(F,{size:28,strokeWidth:2.5})}),e.jsx("h3",{className:"text-lg font-black text-zinc-900 dark:text-white",children:"Sync Complete"}),e.jsx("p",{className:"text-xs text-zinc-400 mt-1",children:"Database updated successfully"})]})]})})}export{ae as default};
