const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CDkxVpyL.js","assets/index-CZDvCB6v.css","assets/papaparse.min-C1-Nmz3e.js","assets/index-B6h196zp.js","assets/addYears-C7ezsmVv.js","assets/format-DU8rxv2E.js","assets/setYear-BV4xPqlg.js","assets/parse-ChHvz_2n.js"])))=>i.map(i=>d[i]);
import{d as I,ad as x,ae as M,af as R,ag as P,g as f,f as i,p as D,w as O,n as F,m as V,H as B,i as N,o as L,x as A,ah as C,q as E,l as q,t as K,v as z,r as v}from"./index-CDkxVpyL.js";import{Q,u as U}from"./useBaseQuery-CcOuYnM9.js";import{c as T}from"./configService-BD4Z94ql.js";const j=[["path",{d:"M4 22V4a1 1 0 0 1 .4-.8A6 6 0 0 1 8 2c3 0 5 2 7.333 2q2 0 3.067-.8A1 1 0 0 1 20 4v10a1 1 0 0 1-.4.8A6 6 0 0 1 16 16c-3 0-5-2-8-2a6 6 0 0 0-4 1.528",key:"1jaruq"}]],tt=I("flag",j);const H=[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]],et=I("inbox",H);var Z=class extends Q{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:x()})}getOptimisticResult(e){return e.behavior=x(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){const{state:r}=e,s=super.createResult(e,t),{isFetching:n,isRefetching:c,isError:u,isRefetchError:o}=s,g=r.fetchMeta?.fetchMore?.direction,l=u&&g==="forward",p=n&&g==="forward",S=u&&g==="backward",y=n&&g==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:R(t,r.data),hasPreviousPage:M(t,r.data),isFetchNextPageError:l,isFetchingNextPage:p,isFetchPreviousPageError:S,isFetchingPreviousPage:y,isRefetchError:o&&!l&&!S,isRefetching:c&&!p&&!y}}};function G(e,t){return U(e,Z)}const d="ticket_logs",J="https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec",_=async(e,t)=>{const r={action:e,ticketNumber:t.ticketNumber||t.id||"",ticketType:t.type||t.ticketType||"",status:t.status||"",severity:t.severity||"",category:t.category||"",subCategory:t.subCategory||"",shortDescription:t.shortDesc||t.shortDescription||"",detail:t.details||t.detail||"",actionTaken:t.action||t.actionTaken||"",resolvedDetail:t.resolvedDetail||"",responsibility:t.responsibility||"",assign:t.assign||"",remark:t.remark||"",date:t.createdAt||t.date||""};try{fetch(J,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(r)}).catch(s=>console.error("Sync Net Error",s))}catch(s){console.error("Sync Error",s)}},W={subscribeLogs:(e,t=50)=>{const r=E(N(i,d),L("createdAt","desc"),A(t));return z(r,s=>{const n=s.docs.map(c=>({id:c.id,ticketNumber:c.id,...c.data()}));e(n,s.docs[s.docs.length-1])})},fetchMoreLogs:async(e,t=20)=>{try{const r=[L("createdAt","desc"),A(t)];e&&r.push(C(e));const s=E(N(i,d),...r),n=await q(s);return{data:n.docs.map(c=>({id:c.id,ticketNumber:c.id,...c.data()})),lastDoc:n.docs[n.docs.length-1]||null}}catch(r){K(r)}},importLogsFromSheet:async e=>{const r=[];for(let s=0;s<e.length;s+=500)r.push(e.slice(s,s+500));for(const s of r){const n=O(i);s.forEach(c=>{const u=c.ticketNumber?f(i,d,String(c.ticketNumber)):f(N(i,d));n.set(u,{...c,createdAt:c.date?new Date(c.date).toISOString():new Date().toISOString(),importedAt:new Date().toISOString()},{merge:!0})}),await n.commit()}return{success:!0,count:e.length}},createLog:async e=>{if(!e.ticketNumber||e.ticketNumber.trim()==="")throw new Error("Ticket Number is required");const t=String(e.ticketNumber).trim(),r=f(i,d,t);if((await D(r)).exists())throw new Error(`Ticket #${t} already exists! Please use a different ticket number.`);await B(r,{...e,ticketNumber:t,createdAt:new Date().toISOString()}),_("create",{...e,ticketNumber:t})},updateLog:async(e,t)=>{const r=f(i,d,String(e));await V(r,t);const s=await D(r);if(s.exists()){const n={ticketNumber:e,...s.data()};_("update",n)}},deleteLog:async e=>{const t=f(i,d,String(e));await F(t),_("delete",{ticketNumber:e})},checkAndSyncTickets:async()=>{const{useSyncStatus:e}=await P(async()=>{const{useSyncStatus:r}=await import("./index-CDkxVpyL.js").then(s=>s.aA);return{useSyncStatus:r}},__vite__mapDeps([0,1])),t=e.getState();try{t.setChecking();const r=f(i,"system_settings","sync_log"),s=await D(r),n=new Date().toISOString().split("T")[0];if(s.exists()&&s.data().lastSyncDate===n)return t.setDone(0,!0),{synced:!1,reason:"already_synced"};t.setSyncing();const c=await fetch("https://script.google.com/macros/s/AKfycbx9UZBOfgKbXPIn_WFK8U35t2t9bd1G4VDVJ6vOcyjKPLz2If9ABgb-NjxBMB9LdD3Z/exec");if(!c.ok)throw new Error("Failed to fetch CSV");const u=await c.text(),o=await P(()=>import("./papaparse.min-C1-Nmz3e.js").then(a=>a.p),__vite__mapDeps([2,0,1])),{parse:g,isValid:l}=await P(async()=>{const{parse:a,isValid:h}=await import("./index-B6h196zp.js");return{parse:a,isValid:h}},__vite__mapDeps([3,4,5,6,7])),p=o.default.parse(u,{header:!0,skipEmptyLines:!0,transformHeader:a=>a.trim()}),S=a=>{if(!a||typeof a!="string")return null;const h=["d/M/yyyy","yyyy-MM-dd","dd/MM/yy","dd/MM/yyyy"],b=new Date;for(const w of h){const k=g(a.trim(),w,b);if(l(k))return k.toISOString()}return null},y=O(i);let m=0;return p.data.forEach(a=>{const h=a["Ticket Number"]||a["Ticket No"];if(!h)return;const b=S(a.Date)||new Date().toISOString(),w=f(i,d,String(h)),k={ticketNumber:h,shortDesc:a["Short Description & Detail"]||a.Detail||a.Description||"",status:a.Status||"Open",type:a["Ticket Type"]||"Incident",assign:a.Assign||"Unassigned",details:a.Detail||"",action:a.Ation||a.Action||"",resolvedDetail:a["Resolved detail"]||"",remark:a.Remark||"",date:b,createdAt:b,importedAt:new Date().toISOString()};y.set(w,k,{merge:!0}),m++}),y.set(r,{lastSyncDate:n},{merge:!0}),await y.commit(),t.setDone(m,!1),{synced:!0,count:m}}catch(r){const{useSyncStatus:s}=await P(async()=>{const{useSyncStatus:n}=await import("./index-CDkxVpyL.js").then(c=>c.aA);return{useSyncStatus:n}},__vite__mapDeps([0,1]));return s.getState().setError(r.message),{synced:!1,reason:"error",error:r.message}}}},st=()=>{const{data:e,fetchNextPage:t,hasNextPage:r,isFetchingNextPage:s,isLoading:n}=G({queryKey:["ticketLogs"],queryFn:async({pageParam:o=null})=>await W.fetchMoreLogs(o),initialPageParam:null,getNextPageParam:o=>o.lastDoc||void 0}),c=e?.pages.flatMap(o=>o.data)||[],u={total:c.length,succeed:c.filter(o=>o.status?.toLowerCase()==="succeed").length,pending:c.filter(o=>o.status?.toLowerCase()==="pending").length,incidents:c.filter(o=>o.status?.toLowerCase()==="open"||o.type==="Incident").length};return{logs:c,loading:n,loadingMore:s,hasMore:r,loadMore:t,stats:u}};function rt(){const[e,t]=v.useState(T.getDefaultTicketOptions()),[r,s]=v.useState(!0);return v.useEffect(()=>{const n=T.subscribeTicketOptions(c=>{t(c),s(!1)});return()=>n()},[]),{ticketOptions:e,loading:r}}export{tt as F,et as I,st as a,W as t,rt as u};
