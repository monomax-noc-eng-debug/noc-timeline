import{h as w,c as d,d as s,n as l,q as f,m as v,b as i,u as p,g as m,a as h,i as R,o as I}from"./firebaseConfig-ZmQab4ju.js";import{t as u}from"./firebaseErrorHandler-CK0dtUN1.js";const o="incidents",A=(e,t)=>{if(!s)return console.error("Firebase not configured! Check your .env file"),t&&t(new Error("Firebase not configured")),e([]),()=>{};try{const n=f(d(s,o),h("createdAt","desc"));return I(n,r=>{const a=r.docs.map(c=>({id:c.id,...c.data()}));e(a)},r=>{console.error("Subscription error:",r.message),t&&t(r),e([])})}catch(n){return t&&t(n),e([]),()=>{}}},O=async e=>{try{const t=i(s,o,e),n=await R(t);return n.exists()?{id:n.id,...n.data()}:null}catch(t){u(t)}},D=async()=>{try{const e=f(d(s,o),h("createdAt","desc"));return(await v(e)).docs.map(n=>({id:n.id,...n.data()}))}catch(e){u(e)}},b=async e=>{try{return(await w(d(s,o),{...e,status:e.status||"Open",priority:e.priority||"Medium",timeline:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),serverTimestamp:l()})).id}catch(t){u(t)}},q=async(e,t)=>{try{const n=i(s,o,e);await p(n,{...t,updatedAt:new Date().toISOString()})}catch(n){u(n)}},T=async e=>{try{const t=i(s,o,e);await m(t)}catch(t){u(t)}},F=(e,t)=>{if(!e)return()=>{};const n=d(s,o,e,"events"),r=f(n);return I(r,a=>{const c=a.docs.map(y=>({id:y.id,...y.data()}));t(c)},a=>console.error("Error subscribing to events sub-collection:",a))},S=async(e,t)=>{try{const n=d(s,o,e,"events"),r={...t,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},a=await w(n,r),c=i(s,o,e);return await p(c,{updatedAt:l()}),{id:a.id,...r}}catch(n){u(n)}},C=async(e,t,n)=>{try{const r=t.id||n.id;if(!r)throw new Error("Event ID missing for update");const a=i(s,o,e,"events",r),c={...n,updatedAt:new Date().toISOString()};return await p(a,c),await p(a,c),{id:r,...c}}catch(r){u(r)}},M=async(e,t)=>{try{const n=t.id;if(!n)throw new Error("Event ID missing for delete");const r=i(s,o,e,"events",n);await m(r)}catch(n){u(n)}},x=async e=>{try{const t=d(s,o,e,"events");return(await v(t)).docs.map(r=>({id:r.id,...r.data()}))}catch(t){return console.error("Error fetching events:",t),[]}},B=S,L=async(e,t,n)=>{const r=i(s,o,e,"events",t);await p(r,{...n,updatedAt:new Date().toISOString()})},N=async(e,t)=>{const n=i(s,o,e,"events",t);await m(n)},z=async(e,t)=>{console.warn("Reorder not fully optimized for sub-collections yet")},P=async e=>{try{let t=0,n=0;for(const r of e){const a=f(d(s,o),where("ticket","==",r.ticket)),c=await v(a),y={...r,updatedAt:new Date().toISOString()};if(c.empty)await w(d(s,o),{...y,createdAt:r.createdAt||new Date().toISOString(),status:r.status||"Open",priority:r.priority||"Medium",timeline:[]}),t++;else{const g=c.docs[0].id,E=i(s,o,g);await p(E,y),n++}}return{created:t,updated:n}}catch(t){throw console.error("Import Error:",t),t}},k={subscribeIncidents:A,subscribeEvents:F,getIncidentById:O,getIncidents:D,createIncident:b,updateIncident:q,deleteIncident:T,addTimelineEvent:S,updateTimelineEvent:C,deleteTimelineEvent:M,getEvents:x,createEvent:B,updateEvent:L,deleteEvent:N,reorderEvents:z,importIncidentsFromSheet:P};export{k as i,A as s};
